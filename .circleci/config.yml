version: 2.1

jobs:
  run-all-tests:
    docker:
      - image: "us-docker.pkg.dev/pqc-infra-test/circleci-runner/runner:latest"
        auth:
          username: _json_key
          password: $RUNNER_GCR_SA_KEY
    steps:
      - checkout
      - run:
          name: "Run all test targets"
          command: |
            export GOOGLE_APPLICATION_CREDENTIALS="${HOME}/gcloud-service-key.json"
            echo ${BAZEL_CACHE_GCS_SA_KEY} > ${GOOGLE_APPLICATION_CREDENTIALS}
            bazelisk test --remote_cache=https://storage.googleapis.com/bazel-cache-bucket-3100644879 \
              --google_default_credentials \
              //...
      - run:
          name: "Build the Go bindings natively"
          command: |
            export GOOGLE_APPLICATION_CREDENTIALS="${HOME}/gcloud-service-key.json"
            echo ${BAZEL_CACHE_GCS_SA_KEY} > ${GOOGLE_APPLICATION_CREDENTIALS}
            bazelisk build --remote_cache=https://storage.googleapis.com/bazel-cache-bucket-3100644879 \
              --google_default_credentials \
              c/...
            export CC=clang-13
            export CXX=clang++-13
            cd go && go build
  publish-doc:
    docker:
      - image: "us-docker.pkg.dev/pqc-infra-test/circleci-runner/runner:latest"
        auth:
          username: _json_key
          password: $RUNNER_GCR_SA_KEY
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "cb:67:a0:71:3b:89:1b:19:d6:40:d5:b8:84:38:33:a4"
      - run:
          name: "Deploy documentation"
          command: |
            doczip=$(bazelisk cquery --output files //rust:sandwich_openssl_ffi_doc)
            bazelisk build //rust:sandwich_openssl_ffi_doc
            cp -r ${doczip} docs/rust
            guidedoczip=$(bazelisk cquery --output files //docs/guide_doc:mdbook_html)
            bazelisk build //docs/guide_doc:mdbook_html
            unzip ${guidedoczip}
            mkdocs gh-deploy --force --config-file mkdocs.yml

workflows:
  presubmit:
    jobs:
      - run-all-tests:
          context:
            - bazel-cache
      - publish-doc:
          filters:
            branches:
              only:
                - main
