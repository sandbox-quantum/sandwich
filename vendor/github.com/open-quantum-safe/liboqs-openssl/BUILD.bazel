# This genrule is a workaround for building liboqs from oqs repository
# with OpenSSL from oqs repository too.
#
# What is the issue ?
# > For building liboqs, you need OpenSSL, and to be more precise you need
# OpenSSL headers for compiling liboqs.
# oqs has a fork of OpenSSL with liboqs integration. This fork needs liboqs
# too.
# The idea is to install OpenSSL using for example your package manager. Then,
# compile liboqs, and finally compile the OpenSSL fork from oqs.
#
# However, using bazel, it can't work:
#
# liboqs needs OpenSSL
# OpenSSL-oqs needs liboqs
# <=> OpenSSL-oqs needs OpenSSL
#
# This leads to an issue when linking `cc_binary`: duplicated symbols
#
# This genrule solves this issue by removing the dependency to OpenSSL (the
# original one).
#
# Here is how this trick works:
#
#   1. Get source of openssl-oqs and liboqs
#
#   2. Create two directories for building the two projects:
#       * `openssl_build`
#       * `liboqs_build`
#      and one extra directory for gathering all headers and libraries:
#       * `install`
#      When building openssl, a directory called `include` will be created under
#      the directory `openssl_build`.
#
#   2. Under the openssl-oqs' source directory, create the directory `lib`
#      and touch the two following files: `libssl.so` and `libcrypto.so`
#
#   3. Configure liboqs using CMake, and hint CMake that the root of OpenSSL
#      is at the source directory of openssl-oqs:
#       * cmake -B build -DCMAKE_INSTALL_PREFIX=$HOME/install \
#                        -DOPENSSL_ROOT_DIR=<path_to_openssl-oqs_source> \
#                        -DCMAKE_BUILD_TYPE=Release
#      CMake is going to check that `$OPENSSL_ROOT_DIR/lib/libcrypto.so` and
#      `$OPENSSL_ROOT_DIR/lib/libssl.so` exists. Then do (we touched them).
#      Therefore, liboqs will use the headers at `$OPENSSL_ROOT_DIR/include`.
#      Now, under `liboqs_build/` there is a directory `include` which contains
#      all the liboqs' headers.
#
#   4. Now, we configure OpenSSL, under the directory `openssl_build`:
#       * ./../openssl-oqs-src/config --prefix=$HOME/install \
#                                     --openssldir=$HOME/install <your config> \
#              -isystem $HOME/liboqs_build/include \
#              -L$HOME/liboqs_build/lib \
#              -Wl,-rpath=$HOME/liboqs_build/lib
#      OpenSSL is now configured, but we cannot compile `libcrypto.so` or
#      `libssl.so` because it needs `liboqs.a`.
#
#   5. Some headers are missing under `$OPENSSL_ROOT_DIR/include` (like
#      `opensslconf.h`). They are needed for building liboqs. For generating
#       them, we use the target `build_generated`:
#       * make build_generated
#      Now, the missing headers are now living under `openssl_build/include`.
#
#   6. We reconfigure liboqs for telling the compiler to also look at
#      `openssl_build/include` for finding headers:
#       * cmake -B liboqs_build -DCMAKE_C_FLAGS="-isystem $HOME/openssl_build/include"
#      Now, we compile liboqs, and install it under `install` directory:
#       * cmake --build liboqs_build -j
#       * cmake --install liboqs_build
#
#   7. Finally, we compile OpenSSL (and we skip tests):
#       * cd openssl_build && make -o test -j && make install_sw
#
# Now, we have all OpenSSL headers + liboqs headers under `install/include`
# and OpenSSL libraries + liboqs libraries under `install/lib`
genrule(
    name = "liboqs-openssl-base",
    srcs = [
        "@open-quantum-safe.openssl_no_liboqs//:all_srcs",
        "@open-quantum-safe.liboqs//:all_srcs",
    ],
    outs = [
        "bin/c_rehash",
        "bin/openssl",
        "include/openssl/x509.h",
        "include/openssl/ocsp.h",
        "include/openssl/conf_api.h",
        "include/openssl/sha.h",
        "include/openssl/txt_db.h",
        "include/openssl/cast.h",
        "include/openssl/ui.h",
        "include/openssl/asn1.h",
        "include/openssl/rc4.h",
        "include/openssl/e_os2.h",
        "include/openssl/tserr.h",
        "include/openssl/srp.h",
        "include/openssl/dh.h",
        "include/openssl/ssl.h",
        "include/openssl/cmac.h",
        "include/openssl/bioerr.h",
        "include/openssl/buffererr.h",
        "include/openssl/err.h",
        "include/openssl/conf.h",
        "include/openssl/idea.h",
        "include/openssl/cmserr.h",
        "include/openssl/crypto.h",
        "include/openssl/rand_drbg.h",
        "include/openssl/randerr.h",
        "include/openssl/pemerr.h",
        "include/openssl/x509v3.h",
        "include/openssl/tls1.h",
        "include/openssl/opensslv.h",
        "include/openssl/hmac.h",
        "include/openssl/aes.h",
        "include/openssl/store.h",
        "include/openssl/objectserr.h",
        "include/openssl/rc5.h",
        "include/openssl/uierr.h",
        "include/openssl/asn1t.h",
        "include/openssl/ebcdic.h",
        "include/openssl/dsaerr.h",
        "include/openssl/ecerr.h",
        "include/openssl/seed.h",
        "include/openssl/ssl2.h",
        "include/openssl/asn1err.h",
        "include/openssl/pkcs7.h",
        "include/openssl/evp.h",
        "include/openssl/dsa.h",
        "include/openssl/cterr.h",
        "include/openssl/bn.h",
        "include/openssl/cryptoerr.h",
        "include/openssl/pem2.h",
        "include/openssl/cms.h",
        "include/openssl/kdf.h",
        "include/openssl/mdc2.h",
        "include/openssl/ocsperr.h",
        "include/openssl/md4.h",
        "include/openssl/pkcs12err.h",
        "include/openssl/ripemd.h",
        "include/openssl/storeerr.h",
        "include/openssl/pem.h",
        "include/openssl/kdferr.h",
        "include/openssl/stack.h",
        "include/openssl/obj_mac.h",
        "include/openssl/asyncerr.h",
        "include/openssl/comp.h",
        "include/openssl/engine.h",
        "include/openssl/ecdsa.h",
        "include/openssl/pkcs12.h",
        "include/openssl/ssl3.h",
        "include/openssl/rsa.h",
        "include/openssl/whrlpool.h",
        "include/openssl/x509_vfy.h",
        "include/openssl/ecdh.h",
        "include/openssl/async.h",
        "include/openssl/symhacks.h",
        "include/openssl/rsaerr.h",
        "include/openssl/lhash.h",
        "include/openssl/x509v3err.h",
        "include/openssl/dtls1.h",
        "include/openssl/engineerr.h",
        "include/openssl/camellia.h",
        "include/openssl/bio.h",
        "include/openssl/evperr.h",
        "include/openssl/ct.h",
        "include/openssl/modes.h",
        "include/openssl/objects.h",
        "include/openssl/md2.h",
        "include/openssl/ec.h",
        "include/openssl/sslerr.h",
        "include/openssl/dherr.h",
        "include/openssl/rc2.h",
        "include/openssl/blowfish.h",
        "include/openssl/safestack.h",
        "include/openssl/conferr.h",
        "include/openssl/md5.h",
        "include/openssl/pkcs7err.h",
        "include/openssl/rand.h",
        "include/openssl/des.h",
        "include/openssl/asn1_mac.h",
        "include/openssl/srtp.h",
        "include/openssl/bnerr.h",
        "include/openssl/opensslconf.h",
        "include/openssl/buffer.h",
        "include/openssl/ts.h",
        "include/openssl/comperr.h",
        "include/openssl/ossl_typ.h",
        "include/openssl/x509err.h",
        "include/oqs/oqsconfig.h",
        "include/oqs/kem.h",
        "include/oqs/kem_frodokem.h",
        "include/oqs/sha2.h",
        "include/oqs/sig_falcon.h",
        "include/oqs/kem_bike.h",
        "include/oqs/kem_ntru.h",
        "include/oqs/common.h",
        "include/oqs/kem_classic_mceliece.h",
        "include/oqs/kem_hqc.h",
        "include/oqs/aes.h",
        "include/oqs/kem_saber.h",
        "include/oqs/sha3x4.h",
        "include/oqs/oqs.h",
        "include/oqs/sha3.h",
        "include/oqs/sig.h",
        "include/oqs/sig_picnic.h",
        "include/oqs/sig_sphincs.h",
        "include/oqs/kem_ntruprime.h",
        "include/oqs/kem_kyber.h",
        "include/oqs/sig_rainbow.h",
        "include/oqs/sig_dilithium.h",
        "include/oqs/rand.h",
        "lib/pkgconfig/libssl.pc",
        "lib/pkgconfig/liboqs.pc",
        "lib/pkgconfig/libcrypto.pc",
        "lib/pkgconfig/openssl.pc",
        "lib/libssl.a",
        "lib/libcrypto.a",
        "lib/liboqs.a",
        "lib/openssl.cnf",
    ],
    cmd = """export INSTALL_DIR=$$PWD/$(RULEDIR)
           export ROOT_DIR=$$PWD
           mkdir -p openssl_build/lib
           mkdir -p $$ROOT_DIR/external/open-quantum-safe.openssl_no_liboqs/lib
           touch $$ROOT_DIR/external/open-quantum-safe.openssl_no_liboqs/lib/libcrypto.so
           touch $$ROOT_DIR/external/open-quantum-safe.openssl_no_liboqs/lib/libssl.so
           cmake -S external/open-quantum-safe.liboqs \
                 -B $$PWD/liboqs_build \
                 -DCMAKE_BUILD_TYPE=Release \
                 -DCMAKE_INSTALL_PREFIX=$$INSTALL_DIR \
                 -DOPENSSL_ROOT_DIR=$$ROOT_DIR/external/open-quantum-safe.openssl_no_liboqs/ \
                 -DOQS_BUILD_ONLY_LIB=ON \
                 -DCMAKE_C_FLAGS="-isystem $$PWD/openssl_build/include"
           (
            cd openssl_build
            $$ROOT_DIR/external/open-quantum-safe.openssl_no_liboqs/config no-weak-ssl-ciphers \
                     no-srp \
                     no-psk \
                     no-dtls \
                     no-idea \
                     no-ssl2 \
                     no-ssl3 \
                     no-comp \
                     no-shared \
                     --openssldir=$$INSTALL_DIR \
                     --prefix=$$INSTALL_DIR \
                     -isystem $$ROOT_DIR/liboqs_build/include \
                     -L$$ROOT_DIR/liboqs_build/lib \
                     -Wno-bitwise-instead-of-logical \
                     -Wno-unknown-warning-option
            make build_generated
           )
           cmake --build liboqs_build -j $$(nproc)
           cmake --install liboqs_build
           (
            cd openssl_build
            make -j $$(nproc) -o test || make -j $$(nproc) -o test
            make install_sw
            cp $$ROOT_DIR/external/open-quantum-safe.openssl_no_liboqs/apps/openssl.cnf $$INSTALL_DIR/lib/
           )""",
    visibility = ["//visibility:private"],
)

cc_library(
    name = "liboqs",
    srcs = ["lib/liboqs.a"],
    hdrs = [
        "include/oqs/aes.h",
        "include/oqs/common.h",
        "include/oqs/kem.h",
        "include/oqs/kem_bike.h",
        "include/oqs/kem_classic_mceliece.h",
        "include/oqs/kem_frodokem.h",
        "include/oqs/kem_hqc.h",
        "include/oqs/kem_kyber.h",
        "include/oqs/kem_ntru.h",
        "include/oqs/kem_ntruprime.h",
        "include/oqs/kem_saber.h",
        "include/oqs/oqs.h",
        "include/oqs/oqsconfig.h",
        "include/oqs/rand.h",
        "include/oqs/sha2.h",
        "include/oqs/sha3.h",
        "include/oqs/sha3x4.h",
        "include/oqs/sig.h",
        "include/oqs/sig_dilithium.h",
        "include/oqs/sig_falcon.h",
        "include/oqs/sig_picnic.h",
        "include/oqs/sig_rainbow.h",
        "include/oqs/sig_sphincs.h",
    ],
    strip_include_prefix = "include/",
)

cc_library(
    name = "openssl-crypto",
    srcs = ["lib/libcrypto.a"],
    hdrs = [
        "include/openssl/aes.h",
        "include/openssl/asn1.h",
        "include/openssl/asn1_mac.h",
        "include/openssl/asn1err.h",
        "include/openssl/asn1t.h",
        "include/openssl/async.h",
        "include/openssl/asyncerr.h",
        "include/openssl/bio.h",
        "include/openssl/bioerr.h",
        "include/openssl/blowfish.h",
        "include/openssl/bn.h",
        "include/openssl/bnerr.h",
        "include/openssl/buffer.h",
        "include/openssl/buffererr.h",
        "include/openssl/camellia.h",
        "include/openssl/cast.h",
        "include/openssl/cmac.h",
        "include/openssl/cms.h",
        "include/openssl/cmserr.h",
        "include/openssl/comp.h",
        "include/openssl/comperr.h",
        "include/openssl/conf.h",
        "include/openssl/conf_api.h",
        "include/openssl/conferr.h",
        "include/openssl/crypto.h",
        "include/openssl/cryptoerr.h",
        "include/openssl/ct.h",
        "include/openssl/cterr.h",
        "include/openssl/des.h",
        "include/openssl/dh.h",
        "include/openssl/dherr.h",
        "include/openssl/dsa.h",
        "include/openssl/dsaerr.h",
        "include/openssl/dtls1.h",
        "include/openssl/e_os2.h",
        "include/openssl/ebcdic.h",
        "include/openssl/ec.h",
        "include/openssl/ecdh.h",
        "include/openssl/ecdsa.h",
        "include/openssl/ecerr.h",
        "include/openssl/engine.h",
        "include/openssl/engineerr.h",
        "include/openssl/err.h",
        "include/openssl/evp.h",
        "include/openssl/evperr.h",
        "include/openssl/hmac.h",
        "include/openssl/idea.h",
        "include/openssl/kdf.h",
        "include/openssl/kdferr.h",
        "include/openssl/lhash.h",
        "include/openssl/md2.h",
        "include/openssl/md4.h",
        "include/openssl/md5.h",
        "include/openssl/mdc2.h",
        "include/openssl/modes.h",
        "include/openssl/obj_mac.h",
        "include/openssl/objects.h",
        "include/openssl/objectserr.h",
        "include/openssl/ocsp.h",
        "include/openssl/ocsperr.h",
        "include/openssl/opensslconf.h",
        "include/openssl/opensslv.h",
        "include/openssl/ossl_typ.h",
        "include/openssl/pem.h",
        "include/openssl/pem2.h",
        "include/openssl/pemerr.h",
        "include/openssl/pkcs12.h",
        "include/openssl/pkcs12err.h",
        "include/openssl/pkcs7.h",
        "include/openssl/pkcs7err.h",
        "include/openssl/rand.h",
        "include/openssl/rand_drbg.h",
        "include/openssl/randerr.h",
        "include/openssl/rc2.h",
        "include/openssl/rc4.h",
        "include/openssl/rc5.h",
        "include/openssl/ripemd.h",
        "include/openssl/rsa.h",
        "include/openssl/rsaerr.h",
        "include/openssl/safestack.h",
        "include/openssl/seed.h",
        "include/openssl/sha.h",
        "include/openssl/srp.h",
        "include/openssl/srtp.h",
        "include/openssl/ssl.h",
        "include/openssl/ssl2.h",
        "include/openssl/ssl3.h",
        "include/openssl/sslerr.h",
        "include/openssl/stack.h",
        "include/openssl/store.h",
        "include/openssl/storeerr.h",
        "include/openssl/symhacks.h",
        "include/openssl/tls1.h",
        "include/openssl/ts.h",
        "include/openssl/tserr.h",
        "include/openssl/txt_db.h",
        "include/openssl/ui.h",
        "include/openssl/uierr.h",
        "include/openssl/whrlpool.h",
        "include/openssl/x509.h",
        "include/openssl/x509_vfy.h",
        "include/openssl/x509err.h",
        "include/openssl/x509v3.h",
        "include/openssl/x509v3err.h",
        "include/oqs/aes.h",
        "include/oqs/common.h",
        "include/oqs/kem.h",
        "include/oqs/kem_bike.h",
        "include/oqs/kem_classic_mceliece.h",
        "include/oqs/kem_frodokem.h",
        "include/oqs/kem_hqc.h",
        "include/oqs/kem_kyber.h",
        "include/oqs/kem_ntru.h",
        "include/oqs/kem_ntruprime.h",
        "include/oqs/kem_saber.h",
        "include/oqs/oqs.h",
        "include/oqs/oqsconfig.h",
        "include/oqs/rand.h",
        "include/oqs/sha2.h",
        "include/oqs/sha3.h",
        "include/oqs/sha3x4.h",
        "include/oqs/sig.h",
        "include/oqs/sig_dilithium.h",
        "include/oqs/sig_falcon.h",
        "include/oqs/sig_picnic.h",
        "include/oqs/sig_rainbow.h",
        "include/oqs/sig_sphincs.h",
    ],
    linkopts = [
        "-lpthread",
        "-ldl",
    ],
    strip_include_prefix = "include/",
    visibility = ["//visibility:public"],
    deps = [":liboqs"],
)

cc_library(
    name = "openssl-ssl",
    srcs = ["lib/libssl.a"],
    visibility = ["//visibility:public"],
    deps = [":openssl-crypto"],
)

cc_library(
    name = "openssl",
    visibility = ["//visibility:public"],
    deps = [
        "openssl-ssl",
        ":openssl-crypto",
    ],
)

filegroup(
    name = "openssl-cli",
    srcs = ["bin/openssl"],
    data = [":liboqs-openssl-base"],
    visibility = ["//visibility:public"],
)

filegroup(
    name = "openssl-conf",
    srcs = ["lib/openssl.cnf"],
    data = [":liboqs-openssl-base"],
    visibility = ["//visibility:public"],
)
